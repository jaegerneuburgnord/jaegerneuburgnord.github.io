<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <title>Wildkamera SMS‑Steuerung</title> <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"> <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-extensions.css">
    <link rel="stylesheet" href="map-styles.css">
    <style>
        /* Banner mit Wald‑Silhouette */
        header {
            height: 120px;
            background: url('icons/forest-silhouette.png') center/cover no-repeat, #4CAF50;
            position: relative;
        }
        header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.4);
            pointer-events: none;
        }
        .header-content {
            position: relative;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            height: 100%;
        }
        .header-title {
            color: white;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 28px;
        }
        #nav-mobile {
            display: flex;
            margin: 0;
            padding: 0;
            list-style: none;
            gap: 10px;
        }
        #nav-mobile li {
            display: inline-block;
        }
        #nav-mobile li a {
            color: white;
            font-size: 28px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }
        #nav-mobile li a:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        .navbar-fixed .nav-wrapper{background:transparent;box-shadow:none;position:relative}
        .tabs-container{margin-top:16px}

        /* Fullscreen Modal für Karte */
        .modal.modal-fullscreen {
            width: 95% !important;
            height: 95% !important;
            max-height: 95% !important;
            top: 2.5% !important;
        }

        .modal.modal-fullscreen .modal-content {
            height: calc(100% - 56px);
            padding: 0;
        }

        /* Map-Container */
        #map {
            z-index: 1;
        }

        /* Leaflet Attribution fix für Modal */
        .leaflet-control-attribution {
            font-size: 10px;
        }

        /* Verstecktes Feature initial ausblenden */
        #directSmsRadio:not(:checked) {
            display: none;
        }

        #directSmsRadio + span {
            display: none;
        }

        /* Main Tabs Styling */
        .main-tabs {
            background-color: #4CAF50;
            margin-bottom: 0;
        }

        .main-tabs .tab a {
            color: rgba(255, 255, 255, 0.7);
        }

        .main-tabs .tab a:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .main-tabs .tab a.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-tabs .indicator {
            background-color: white;
        }

        /* Tab Content Container */
        .tab-content-container {
            min-height: calc(100vh - 200px);
        }

        /* Map Controls */
        .map-controls {
            position: relative;
            z-index: 1000;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-controls button {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        /* Leaflet fix for tab switching */
        #map-tab .leaflet-container {
            height: 100%;
        }

        /* Map-First Layout Styles */
        .map-first-layout #map-tab {
            position: relative;
        }

        .camera-sidebar {
            position: absolute;
            top: 60px;
            left: 10px;
            width: 300px;
            max-height: calc(100vh - 300px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .camera-sidebar .sidebar-header {
            padding: 15px;
            background: #4CAF50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-sidebar .sidebar-header h6 {
            margin: 0;
            font-size: 16px;
        }

        .camera-sidebar .sidebar-content {
            overflow-y: auto;
            flex: 1;
        }

        .camera-sidebar .collection {
            margin: 0;
            border: none;
        }

        .camera-sidebar .collection-item {
            cursor: pointer;
            font-size: 14px;
            padding: 10px 15px;
        }

        .camera-sidebar .collection-item:hover {
            background: #f5f5f5;
        }

        /* Responsive Sidebar */
        @media (max-width: 768px) {
            .camera-sidebar {
                width: 250px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div>
                <h4 class="header-title">Wildkamera Steuerung</h4>
                <div style="color: rgba(255,255,255,0.7); font-size: 11px; margin-top: -5px;">v2025.11.07-210000</div>
            </div>
            <ul id="nav-mobile" class="right">
                <li><a id="serverConfigButton" href="#serverConfigModal" class="modal-trigger" title="Server-Konfiguration"><i class="material-icons">settings_input_antenna</i></a></li>
                <li><a id="installButton" class="hide" href="#" title="App installieren"><i class="material-icons">get_app</i></a></li>
            </ul>
        </div>
    </header>
    <main>
        <!-- Tab Navigation -->
        <div class="row" style="margin-bottom: 0;">
            <div class="col s12">
                <ul class="tabs main-tabs">
                    <li class="tab col s6"><a href="#cameras-tab" class="active">Kameras</a></li>
                    <li class="tab col s6"><a href="#map-tab">Karte</a></li>
                </ul>
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="container main-container">
            <!-- Kameras Tab -->
            <div id="cameras-tab" class="tab-content-container">
                <div class="row">
                    <div id="cameraListContainer" class="col s12">
                        <ul id="cameraList" class="collection"></ul>
                        <div id="loadingIndicator" class="preloader-container hide">
                            <div class="preloader-wrapper small active">
                                <div class="spinner-layer spinner-green-only">
                                    <div class="circle-clipper left">
                                        <div class="circle"></div>
                                    </div>
                                    <div class="gap-patch">
                                        <div class="circle"></div>
                                    </div>
                                    <div class="circle-clipper right">
                                        <div class="circle"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fixed-action-btn add-button">
                    <a id="addCameraButton" class="btn-floating btn-large waves-effect waves-light">
                        <i class="material-icons">add</i>
                    </a>
                </div>
            </div>

            <!-- Karte Tab -->
            <div id="map-tab" class="tab-content-container" style="display: none;">
                <input type="file" id="kmlFileInput" accept=".kml" style="display: none;">
                <div id="map" class="map-container"></div>
            </div>
        </div>
    </main> <!-- Batch‑Action‑Bar -->
    <div id="batchActionBar" class="batch-action-bar hide"> <span id="batchCount">0 Kameras ausgewählt</span>
        <div class="batch-actions center-align"> <i class="material-icons batch-action" data-action="settings">settings</i> <i class="material-icons batch-action" data-action="rename">edit</i> <i class="material-icons batch-action" data-action="photo">photo</i> <i class="material-icons batch-action" data-action="delete">delete</i> </div>
    </div> <!-- Kamera Modal -->
    <div id="cameraModal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4 id="modalTitle">Kamera hinzufügen</h4>
            <div class="row">
                <div class="input-field col s12"><input id="cameraName" type="text" class="validate"><label for="cameraName">Kameraname</label></div>
                <div class="input-field col s12"><input id="cameraPhone" type="tel" class="validate"><label for="cameraPhone">Telefonnummer</label></div>
                <div class="input-field col s12"><select id="cameraType">
                        <option value="24MP">24MP</option>
                        <option value="32MP">32MP</option>
                    </select><label>Kameratyp</label></div>
            </div>
        </div>
        <div class="modal-footer">
			<a class="modal-close waves-effect waves-light btn-flat" href="#">Abbrechen</a>
			<a id="saveCameraButton" class="waves-effect waves-light btn" href="#">Speichern</a>
		</div>
    </div> <!-- Einstellungen Modal -->
    <div id="settingsModal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4>Kamera‑Einstellungen</h4>
            <h5 id="settingsCameraName" class="center-align">Kameraname</h5>
            <div class="tabs-container">
                <ul class="tabs">
                    <li class="tab col s3"><a class="active" href="#generalSettings">Allgemein</a></li>
                    <li class="tab col s3"><a href="#cameraSettings">Kamera</a></li>
                    <li class="tab col s3"><a href="#timerSettings">Zeitplan</a></li>
                    <li class="tab col s3"><a href="#recipientSettings">Empfänger</a></li>
                </ul>
            </div> <!-- Allgemein -->
            <div id="generalSettings" class="settings-panel">
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Täglicher Statusbericht</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="statusReportSwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control"><input id="statusTime" type="text" class="timepicker" placeholder="HH:MM"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">MMS Fernsteuerung</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="mmsControlSwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">EMail Versand</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="smtpSwitch" type="checkbox" checked><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Max. Anzahl</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="maxCountSwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control"><input id="maxCount" type="text" value="Kein Limit"></div>
                </div>
				<div class="row setting-row">
					<div class="col s5 right-align setting-label">FTP Versand</div>
					<div class="col s2"></div>
					<div class="col s5 setting-control">
						<select id="ftpMode" class="browser-default">
							<option value="AUS">AUS</option>
							<option value="FTP">FTP</option>
							<option value="FTPS">FTPS</option>
						</select>
					</div>
				</div>

                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Fernsteuerung</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="smsControl">
                            <option>Sofort</option>
                            <option>Täglich</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Versand Bildgröße</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="imageSize">
                            <option>HD</option>
                            <option>Größer</option>
                            <option>Klein</option>
                        </select></div>
                </div>
            </div> <!-- Kamera -->
            <div id="cameraSettings" class="settings-panel">
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Bewegungssensor</div>
                    <div class="col s5 right-align setting-label">
                        <div class="switch"><label><input id="motionSensorSwitch" type="checkbox" checked><span class="lever"></span></label></div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">SD Zyklus</div>
                    <div class="col s5 right-align setting-label">
                        <div class="switch"><label><input id="sdCycleSwitch" type="checkbox" checked><span class="lever"></span></label></div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Versand Bild</div>
                    <div class="col s5 right-align setting-label">
                        <div class="switch"><label><input id="sendImageSwitch" type="checkbox" checked><span class="lever"></span></label></div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Versand Video</div>
                    <div class="col s5 right-align setting-label">
                        <div class="switch"><label><input id="sendVideoSwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Aufnahme Modus</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="captureMode">
                            <option>Bild</option>
                            <option>Video</option>
                            <option>P+V</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Nacht Modus</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="nightMode">
                            <option>Balance</option>
                            <option>Qualität</option>
                            <option>Öko</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Bildauflösung</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="imageResolution">
                            <option>32M</option>
                            <option>24M</option>
                            <option>12MP</option>
                            <option>8MP</option>
                            <option>5MP</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Videoauflösung</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="videoResolution">
                            <option>FHD-1920x1080</option>
                            <option>HD-1280x720</option>
                            <option>WVGA-848x480</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">PIR Sensibilität</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="pirSensitivity">
                            <option>L1</option>
                            <option>L2</option>
                            <option>L3</option>
                            <option>L4</option>
                            <option>L5</option>
                            <option>L6</option>
                            <option>L7</option>
                            <option>L8</option>
                            <option>L9</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Blitz LED</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="flashLed">
                            <option>Hoch</option>
                            <option>Gering</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Dauer Video</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="videoDuration">
                            <option>5s</option>
                            <option>10s</option>
                            <option>15s</option>
                            <option>20s</option>
                            <option>30s</option>
                            <option>40s</option>
                            <option>50s</option>
                            <option>59s</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Stundensystem</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control"><select id="hourSystem">
                            <option>24h</option>
                            <option>12h</option>
                        </select></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Serienbilder</div>
                    <div class="col s2"></div>
                    <div class="col s5 setting-control">
                        <div class="range-field"><input id="burstImages" type="range" min="1" max="5" value="1"></div><span id="burstImagesValue" class="right">1P</span>
                    </div>
                </div>
            </div> <!-- Zeitplan -->
            <div id="timerSettings" class="settings-panel">
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Timer 1</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="timer1Switch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control">
                        <div class="row" style="margin-bottom:0;">
                            <div class="col s6"><input id="timer1Start" type="text" class="timepicker" placeholder="Start"></div>
                            <div class="col s6"><input id="timer1End" type="text" class="timepicker" placeholder="Ende"></div>
                        </div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Timer 2</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="timer2Switch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control">
                        <div class="row" style="margin-bottom:0;">
                            <div class="col s6"><input id="timer2Start" type="text" class="timepicker" placeholder="Start"></div>
                            <div class="col s6"><input id="timer2End" type="text" class="timepicker" placeholder="Ende"></div>
                        </div>
                    </div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Verzögerung</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="delaySwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control"><input id="delayTime" type="text" placeholder="00:00:00"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s5 right-align setting-label">Zeitraffer</div>
                    <div class="col s2 center-align">
                        <div class="switch"><label><input id="timelapseSwitch" type="checkbox"><span class="lever"></span></label></div>
                    </div>
                    <div class="col s5 setting-control"><input id="timelapseTime" type="text" placeholder="00:00:00"></div>
                </div>
            </div> <!-- Empfänger -->
            <div id="recipientSettings" class="settings-panel">
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Phone 1</div>
                    <div class="col s10 setting-control"><input id="phone1" type="tel" placeholder="Telefonnummer"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Phone 2</div>
                    <div class="col s10 setting-control"><input id="phone2" type="tel" placeholder="Telefonnummer"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Phone 3</div>
                    <div class="col s10 setting-control"><input id="phone3" type="tel" placeholder="Telefonnummer"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Phone 4</div>
                    <div class="col s10 setting-control"><input id="phone4" type="tel" placeholder="Telefonnummer"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Email 1</div>
                    <div class="col s10 setting-control"><input id="email1" type="email" placeholder="E‑Mail"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Email 2</div>
                    <div class="col s10 setting-control"><input id="email2" type="email" placeholder="E‑Mail"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Email 3</div>
                    <div class="col s10 setting-control"><input id="email3" type="email" placeholder="E‑Mail"></div>
                </div>
                <div class="row setting-row">
                    <div class="col s2 right-align setting-label">Email 4</div>
                    <div class="col s10 setting-control"><input id="email4" type="email" placeholder="E‑Mail"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <!-- SMS-Vorschau links -->
            <div class="sms-preview">
              <!--div class="sms-preview-title">SMS Vorschau:</div-->
              <div id="smsPreviewText">Die SMS-Vorschau wird hier angezeigt</div>
            </div>
          
            <!-- Buttons rechts -->
            <div class="footer-actions">
              <a class="modal-close waves-effect waves-light btn-flat" href="#">Abbrechen</a>
              <a id="sendSettingsButton" class="waves-effect waves-light btn" href="#">SMS senden</a>
            </div>
          </div>
        </div>

    <!-- Server-Konfigurations Modal -->
    <div id="serverConfigModal" class="modal">
        <div class="modal-content">
            <h4>Server-Konfiguration</h4>
            <div class="row">
                <div class="input-field col s12">
                    <input id="serverUrl" type="text" class="validate" placeholder="http://localhost:8000">
                    <label for="serverUrl">Server-URL</label>
                </div>
                <div class="col s12">
                    <button id="testConnectionBtn" class="btn waves-effect waves-light">
                        <i class="material-icons left">wifi</i>Verbindung testen
                    </button>
                    <span id="connectionStatus" style="margin-left: 20px;"></span>
                </div>
                <div class="col s12" style="margin-top: 20px;">
                    <h6>App-Layout</h6>
                    <p>
                        <label>
                            <input type="radio" name="layoutMode" value="tabs" checked />
                            <span>Tab-Layout (Kameras / Karte)</span>
                        </label>
                    </p>
                    <p>
                        <label>
                            <input type="radio" name="layoutMode" value="map-first" />
                            <span>Karte als Startseite (mit Kamera-Sidebar)</span>
                        </label>
                    </p>
                </div>
                <div class="col s12" style="margin-top: 20px;">
                    <h6>SMS-Versand Modus</h6>
                    <p>
                        <label>
                            <input type="radio" name="smsMode" value="api" checked />
                            <span>Server-API (Standard)</span>
                        </label>
                    </p>
                    <p>
                        <label>
                            <input type="radio" name="smsMode" value="direct" id="directSmsRadio" />
                            <span>Direkter Browser-SMS (Fallback)</span>
                        </label>
                    </p>
                </div>
                <div class="col s12" style="margin-top: 20px;">
                    <h6>Server-Status</h6>
                    <div id="serverStatusInfo" style="padding: 10px; background: #f5f5f5; border-radius: 4px;">
                        <p id="serverStatus">Status wird geladen...</p>
                        <p id="modemStatus">Modem: Nicht verbunden</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-light btn-flat">Schließen</a>
            <a id="saveServerConfigBtn" href="#!" class="waves-effect waves-light btn">Speichern</a>
        </div>
    </div>

    <!-- Scripts -->
	<script>
	  if ('serviceWorker' in navigator) {
		window.addEventListener('load', () => {
		  navigator.serviceWorker.register('service-worker.js')
			.catch(err => console.warn('SW-Registration failed', err));
		});
	  }
	</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="config.js"></script>
    <script src="db-manager.js"></script>
    <script src="api-client.js"></script>
    <script src="sms-manager.js"></script>
    <script src="kml-manager.js"></script>
    <script src="map-view.js"></script>
    <script src="swipe-navigation.js"></script>
    <script src="offline-map-downloader.js"></script>
    <script src="layout-switcher.js"></script>
    <script src="offline-sync-manager.js"></script>
    <script src="sms-commands.js"></script>
    <script src="app.js"></script>
    <script src="ui-extensions.js"></script>
    <script src="camera-settings.js"></script>
    <script src="sync-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded',()=>{
          // Initialize Layout based on preference
          window.layoutSwitcher.initLayout();

          // Initialize Materialize components
          M.FormSelect.init(document.querySelectorAll('select'));
          M.Timepicker.init(document.querySelectorAll('.timepicker'),{i18n:{cancel:'Abbrechen'}});
          M.Modal.init(document.querySelectorAll('.modal'));

          // Initialize Main Tabs
          const mainTabs = M.Tabs.init(document.querySelectorAll('.main-tabs'), {
              onShow: function(tab) {
                  console.log('Tab onShow triggered:', tab.id);
                  // Wenn Karten-Tab geöffnet wird
                  if (tab.id === 'map-tab') {
                      // Zeige Tab
                      document.getElementById('map-tab').style.display = 'block';
                      document.getElementById('cameras-tab').style.display = 'none';
                      document.body.classList.add('map-tab-active');

                      // Initialisiere Karte wenn noch nicht vorhanden
                      if (!window.mapView.map) {
                          console.log('Initializing map for the first time...');
                          setTimeout(async () => {
                              // Synchronisiere Reviere-KMZ BEVOR Karte initialisiert wird
                              if (navigator.onLine) {
                                  try {
                                      console.log('[Map Tab] Synchronisiere Reviere-KMZ...');
                                      const syncResult = await window.kmlManager.syncReviere();
                                      if (syncResult.success) {
                                          console.log(`[Map Tab] Sync erfolgreich: ${syncResult.message}`);
                                          if (syncResult.downloaded > 0) {
                                              M.toast({ html: `✅ ${syncResult.downloaded} Reviere aktualisiert`, displayLength: 3000 });
                                          }
                                      }
                                  } catch (error) {
                                      console.error('[Map Tab] Sync fehlgeschlagen:', error);
                                  }
                              }

                              // Dann Karte initialisieren
                              window.mapView.initMap('map');
                              await window.mapView.loadAllBoundaries();
                              await window.mapView.loadCameraMarkers();
                              console.log('Map initialized:', window.mapView.map);
                          }, 100);
                      } else {
                          console.log('Map already exists, invalidating size...');

                          // Synchronisiere Reviere auch bei erneutem Öffnen
                          if (navigator.onLine) {
                              setTimeout(async () => {
                                  try {
                                      console.log('[Map Tab] Re-Sync Reviere-KMZ...');
                                      const syncResult = await window.kmlManager.syncReviere();
                                      if (syncResult.success && syncResult.downloaded > 0) {
                                          console.log(`[Map Tab] Re-Sync: ${syncResult.message}`);
                                          M.toast({ html: `✅ ${syncResult.downloaded} Reviere aktualisiert`, displayLength: 2000 });
                                          // Karte neu laden wenn Updates vorhanden
                                          await window.mapView.loadAllBoundaries();
                                      }
                                  } catch (error) {
                                      console.error('[Map Tab] Re-Sync fehlgeschlagen:', error);
                                  }
                              }, 500);
                          }

                          // Leaflet Map invalidate size (wichtig nach Tab-Switch)
                          setTimeout(() => {
                              window.mapView.map.invalidateSize();
                              window.mapView.loadCameraMarkers();
                          }, 100);
                      }
                  } else if (tab.id === 'cameras-tab') {
                      document.getElementById('cameras-tab').style.display = 'block';
                      document.getElementById('map-tab').style.display = 'none';
                      document.body.classList.remove('map-tab-active');
                  }
              }
          });

          // ZUSÄTZLICH: Direkter Event-Listener auf Tab-Links (Fallback)
          document.querySelectorAll('.main-tabs a[href="#map-tab"]').forEach(link => {
              link.addEventListener('click', function() {
                  console.log('Map tab link clicked directly');
                  setTimeout(async () => {
                      if (!window.mapView.map) {
                          console.log('Initializing map after tab click...');

                          // Synchronisiere Reviere
                          if (navigator.onLine) {
                              try {
                                  const syncResult = await window.kmlManager.syncReviere();
                                  if (syncResult.success && syncResult.downloaded > 0) {
                                      M.toast({ html: `✅ ${syncResult.downloaded} Reviere geladen`, displayLength: 2000 });
                                  }
                              } catch (error) {
                                  console.error('Sync error:', error);
                              }
                          }

                          document.body.classList.add('map-tab-active');
                          window.mapView.initMap('map');
                          await window.mapView.loadAllBoundaries();
                          await window.mapView.loadCameraMarkers();
                          console.log('Map initialized:', window.mapView.map);
                      } else {
                          console.log('Map exists, invalidating size...');
                          window.mapView.map.invalidateSize();
                      }
                  }, 200);
              });
          });

          // Initialize Settings Tabs
          M.Tabs.init(document.querySelectorAll('.tabs:not(.main-tabs)'));

          // KML-Upload Handler
          document.getElementById('uploadKmlBtn').addEventListener('click', () => {
              document.getElementById('kmlFileInput').click();
          });

          document.getElementById('kmlFileInput').addEventListener('change', async (e) => {
              const file = e.target.files[0];
              if (file) {
                  try {
                      const result = await window.kmlManager.uploadKml(file);
                      M.toast({ html: result.message, displayLength: 4000 });

                      // Karte neu laden
                      if (window.mapView.map) {
                          await window.mapView.loadAllBoundaries();
                          // Uploaded KML Liste aktualisieren
                          if (window.mapView.populateUploadedKmlList) {
                              await window.mapView.populateUploadedKmlList();
                          }
                      }
                  } catch (error) {
                      M.toast({ html: `Fehler: ${error.message}`, displayLength: 4000 });
                  }
                  // Reset input
                  e.target.value = '';
              }
          });

          // Meine Position anzeigen
          document.getElementById('myLocationBtn').addEventListener('click', async () => {
              console.log('Position button clicked, map exists:', !!window.mapView.map);

              // Prüfe ob wir im Karten-Tab sind
              const mapTab = document.getElementById('map-tab');
              const isMapTabVisible = mapTab && mapTab.style.display !== 'none';

              if (!isMapTabVisible) {
                  M.toast({ html: 'Bitte wechseln Sie zum Karten-Tab', displayLength: 3000 });
                  return;
              }

              // Initialisiere Karte falls noch nicht vorhanden
              if (!window.mapView.map) {
                  console.log('Initializing map for position...');
                  document.body.classList.add('map-tab-active');
                  window.mapView.initMap('map');
                  await window.mapView.loadAllBoundaries();
                  await window.mapView.loadCameraMarkers();
                  console.log('Map initialized for position:', window.mapView.map);
              }

              try {
                  await window.mapView.showCurrentLocation();
                  M.toast({ html: 'Position ermittelt', displayLength: 2000 });
              } catch (error) {
                  console.error('Position error:', error);
                  M.toast({ html: 'Position konnte nicht ermittelt werden', displayLength: 4000 });
              }
          });

          // KML-Sync - Synchronisiere Reviere aus /home/wildkamera/Reviere
          document.getElementById('syncKmlBtn').addEventListener('click', async () => {
              if (!navigator.onLine) {
                  M.toast({ html: '⚠️ Offline - Synchronisation nicht möglich', displayLength: 3000 });
                  return;
              }

              M.toast({ html: 'Synchronisiere Reviere...', displayLength: 2000 });

              try {
                  const result = await window.kmlManager.syncReviere();

                  if (result.success) {
                      let message = `✓ Reviere synchronisiert`;
                      if (result.downloaded > 0) {
                          message += `: ${result.downloaded} neu`;
                      }
                      if (result.deleted > 0) {
                          message += `, ${result.deleted} gelöscht`;
                      }
                      if (result.downloaded === 0 && result.deleted === 0) {
                          message = `✓ Alle Reviere aktuell`;
                      }
                      M.toast({ html: message, displayLength: 4000 });

                      // Karte neu laden wenn Änderungen vorhanden
                      if (window.mapView.map && (result.downloaded > 0 || result.deleted > 0)) {
                          await window.mapView.loadAllBoundaries();
                          window.mapView.fitBoundaries();
                      }
                  } else {
                      M.toast({ html: `✗ Sync fehlgeschlagen: ${result.message}`, displayLength: 5000 });
                  }
              } catch (error) {
                  console.error('Sync-Fehler:', error);
                  M.toast({ html: '✗ Synchronisation fehlgeschlagen', displayLength: 4000 });
              }
          });

          // Server-Konfiguration
          const serverUrl = localStorage.getItem('smsServerUrl') || 'http://localhost:8000';
          document.getElementById('serverUrl').value = serverUrl;

          // Test-Verbindung
          document.getElementById('testConnectionBtn').addEventListener('click', async () => {
              const url = document.getElementById('serverUrl').value;
              window.apiClient.setServerUrl(url);

              const statusSpan = document.getElementById('connectionStatus');
              statusSpan.innerHTML = '<i class="material-icons tiny">hourglass_empty</i> Teste...';

              const connected = await window.apiClient.testConnection();

              if (connected) {
                  statusSpan.innerHTML = '<i class="material-icons tiny green-text">check_circle</i> Verbunden';

                  // Hole Server-Status
                  const status = await window.apiClient.getStatus();
                  document.getElementById('serverStatus').textContent = `Status: ${status.status}`;
                  document.getElementById('modemStatus').textContent = `Modem: ${status.modem_connected ? 'Verbunden' : 'Nicht verbunden'}`;
              } else {
                  statusSpan.innerHTML = '<i class="material-icons tiny red-text">error</i> Nicht erreichbar';
              }
          });

          // Server-Konfiguration speichern
          document.getElementById('saveServerConfigBtn').addEventListener('click', () => {
              const url = document.getElementById('serverUrl').value;
              window.apiClient.setServerUrl(url);

              // Layout-Modus
              const layoutMode = document.querySelector('input[name="layoutMode"]:checked').value;
              if (layoutMode === 'map-first') {
                  window.layoutSwitcher.switchToMapFirstLayout();
              } else {
                  window.layoutSwitcher.switchToTabLayout();
              }

              // SMS-Modus
              const smsMode = document.querySelector('input[name="smsMode"]:checked').value;
              window.smsManager.setDirectSmsMode(smsMode === 'direct');

              M.toast({ html: 'Konfiguration gespeichert - Seite wird neu geladen...', displayLength: 2000 });

              // Seite neu laden um Layout anzuwenden
              setTimeout(() => {
                  location.reload();
              }, 2000);
          });

          // Layout-Modus initialisieren
          const currentLayout = window.layoutSwitcher.getCurrentLayout();
          document.querySelector(`input[name="layoutMode"][value="${currentLayout}"]`).checked = true;

          // Check if map-first layout is active and initialize map
          if (currentLayout === 'map-first') {
              // In map-first layout, initialize map immediately
              setTimeout(() => {
                  if (!window.mapView.map) {
                      window.mapView.initMap('map');
                      window.mapView.loadAllBoundaries();
                      window.mapView.loadCameraMarkers();
                      document.body.classList.add('map-tab-active');
                  }
              }, 100);
          }

          // SMS-Modus initialisieren
          const directSmsEnabled = window.smsManager.isDirectSmsEnabled();
          document.querySelector(`input[name="smsMode"][value="${directSmsEnabled ? 'direct' : 'api'}"]`).checked = true;

          // Easter Egg für verstecktes Feature: 10x auf Header klicken
          let headerClickCount = 0;
          document.querySelector('header').addEventListener('click', () => {
              headerClickCount++;
              if (headerClickCount >= 10) {
                  M.toast({ html: 'Direkter SMS-Modus freigeschaltet!', displayLength: 4000 });
                  document.getElementById('directSmsRadio').closest('p').style.display = 'block';
                  headerClickCount = 0;
              }
          });

          // Swipe-Navigation initialisieren
          if (window.swipeNavigation) {
              window.swipeNavigation.init();
              console.log('Swipe navigation enabled: Swipe left/right to switch tabs');
          }

          // Vollbild-Toggle für Karte
          let isFullscreen = false;
          const toggleFullscreen = () => {
              isFullscreen = !isFullscreen;
              document.body.classList.toggle('map-fullscreen', isFullscreen);

              // Button-Text und Icon aktualisieren
              const fullscreenBtn = document.getElementById('fullscreenBtn');
              if (fullscreenBtn) {
                  if (isFullscreen) {
                      fullscreenBtn.innerHTML = '<i class="material-icons left">fullscreen_exit</i>Normal';
                      M.toast({ html: 'Vollbild aktiviert - Wischen zum Wechseln', displayLength: 2000 });
                  } else {
                      fullscreenBtn.innerHTML = '<i class="material-icons left">fullscreen</i>Vollbild';
                      M.toast({ html: 'Vollbild deaktiviert', displayLength: 2000 });
                  }
              }

              // Karte neu skalieren
              if (window.mapView.map) {
                  setTimeout(() => window.mapView.map.invalidateSize(), 100);
              }
          };

          // Labels Toggle Button
          let labelsVisible = localStorage.getItem('mapLabelsVisible') !== 'false'; // Default: true
          const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');

          // Initiale Einstellung anwenden
          if (!labelsVisible) {
              document.body.classList.add('hide-point-labels');
              if (toggleLabelsBtn) {
                  toggleLabelsBtn.classList.remove('purple');
                  toggleLabelsBtn.classList.add('grey');
              }
          }

          toggleLabelsBtn?.addEventListener('click', () => {
              labelsVisible = !labelsVisible;
              localStorage.setItem('mapLabelsVisible', labelsVisible);

              if (labelsVisible) {
                  document.body.classList.remove('hide-point-labels');
                  toggleLabelsBtn.classList.remove('grey');
                  toggleLabelsBtn.classList.add('purple');
                  M.toast({ html: '✓ Labels werden angezeigt', displayLength: 2000 });
              } else {
                  document.body.classList.add('hide-point-labels');
                  toggleLabelsBtn.classList.remove('purple');
                  toggleLabelsBtn.classList.add('grey');
                  M.toast({ html: '✓ Labels sind ausgeblendet', displayLength: 2000 });
              }
          });

          // Vollbild-Button Event
          document.getElementById('fullscreenBtn')?.addEventListener('click', toggleFullscreen);

          // Offline-Download Button
          document.getElementById('downloadOfflineBtn')?.addEventListener('click', async () => {
              if (!window.mapView.map) {
                  M.toast({ html: 'Karte nicht geladen', displayLength: 2000 });
                  return;
              }

              const bounds = window.mapView.map.getBounds();
              const currentZoom = window.mapView.map.getZoom();

              // Berechne Download-Größe
              const estimate = window.offlineMapDownloader.estimateDownloadSize(
                  bounds,
                  Math.max(currentZoom - 2, 10),
                  Math.min(currentZoom + 2, 16)
              );

              // Bestätigungsdialog
              const confirmed = confirm(
                  `Offline-Karten Download:\n\n` +
                  `Bereich: Aktuelle Ansicht\n` +
                  `Kacheln: ${estimate.tileCount}\n` +
                  `Größe: ~${estimate.estimatedSizeMB} MB\n` +
                  `Zoom-Stufen: ${Math.max(currentZoom - 2, 10)} - ${Math.min(currentZoom + 2, 16)}\n\n` +
                  `Download starten?`
              );

              if (!confirmed) return;

              // Hole aktuellen Layer
              const savedLayer = localStorage.getItem('selectedMapLayer') || 'OpenStreetMap';
              let layerUrl = '';

              switch(savedLayer) {
                  case 'OpenStreetMap':
                      layerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                      break;
                  case 'Google Satellite':
                      layerUrl = 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';
                      break;
                  case 'Google Hybrid':
                      layerUrl = 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}';
                      break;
                  case 'Esri Satellite':
                      layerUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                      break;
                  case 'OpenTopoMap':
                      layerUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                      break;
                  default:
                      layerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
              }

              // Download starten
              await window.offlineMapDownloader.downloadArea(
                  bounds,
                  layerUrl,
                  Math.max(currentZoom - 2, 10),
                  Math.min(currentZoom + 2, 16)
              );
          });

          // Cache-Statistiken im Kartensteuerungs-Widget anzeigen
          window.addEventListener('offline-download-progress', (e) => {
              const { progress, downloaded, total } = e.detail;
              console.log(`Download: ${progress}% (${downloaded}/${total})`);
          });

          // Doppel-Tap auf Karte für Vollbild (optional)
          let lastTap = 0;
          document.getElementById('map-tab')?.addEventListener('touchend', (e) => {
              const currentTime = new Date().getTime();
              const tapLength = currentTime - lastTap;

              if (tapLength < 300 && tapLength > 0) {
                  // Doppel-Tap erkannt
                  if (e.target.closest('#map')) {
                      toggleFullscreen();
                  }
              }
              lastTap = currentTime;
          });
        });
    </script>
</body>

</html>